<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTC Sports Center - Mobile Schedule</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --tennis-green: #90EE90;
            --pickleball-blue: #87CEEB;
            --tentative-yellow: #FFD700;
            --available-white: #FFFFFF;
            --header-bg: #343a40;
            --border-color: #dee2e6;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 80px;
        }

        .mobile-header {
            background: linear-gradient(135deg, var(--header-bg), #495057);
            color: white;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .mobile-header h1 {
            font-size: 1.5rem;
            margin: 0;
            text-align: center;
        }

        .mobile-header .subtitle {
            font-size: 0.9rem;
            text-align: center;
            opacity: 0.8;
            margin-top: 0.25rem;
        }

        .mobile-controls {
            background: white;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 80px;
            z-index: 999;
            transition: transform 0.3s ease;
        }

        .mobile-controls.hidden {
            transform: translateY(-100%);
            margin-bottom: 0;
            height: 0;
            overflow: hidden;
        }

        .day-selector {
            margin-bottom: 1rem;
        }

        .day-selector select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background: white;
        }

        .time-range-selector {
            margin-bottom: 1rem;
        }

        .time-range-selector select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background: white;
        }

        .quick-time-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .quick-time-btn {
            flex: 1;
            min-width: 70px;
            padding: 0.5rem 0.25rem;
            border: 2px solid var(--border-color);
            border-radius: 20px;
            background: white;
            font-size: 0.7rem;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }

        .quick-time-btn.active {
            background-color: var(--tennis-green);
            border-color: var(--tennis-green);
            color: white;
        }

        .quick-time-btn i {
            font-size: 1rem;
        }

        .show-booked-toggle {
            margin-bottom: 1rem;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .toggle-switch input {
            display: none;
        }

        .toggle-slider {
            width: 50px;
            height: 24px;
            background-color: #ccc;
            border-radius: 24px;
            position: relative;
            transition: background-color 0.3s ease;
        }

        .toggle-slider:before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--tennis-green);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .toggle-label {
            font-weight: 500;
            color: #333;
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .filter-btn {
            flex: 1;
            min-width: 80px;
            padding: 0.5rem;
            border: 2px solid var(--border-color);
            border-radius: 20px;
            background: white;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background-color: var(--tennis-green);
            border-color: var(--tennis-green);
            color: white;
        }

        .search-box {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
        }

        /* Card-based layout for mobile */
        .time-slot-card {
            background: white;
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .time-slot-header {
            background: var(--header-bg);
            color: white;
            padding: 0.75rem 1rem;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .courts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }

        .court-card {
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
        }

        .court-card:nth-child(2n) {
            border-right: none;
        }

        .court-card:last-child,
        .court-card:nth-last-child(2) {
            border-bottom: none;
        }

        .court-name {
            font-size: 0.7rem;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }

        .court-content {
            font-size: 0.9rem;
            font-weight: 600;
            line-height: 1.2;
        }

        .court-status {
            font-size: 0.6rem;
            padding: 0.1rem 0.3rem;
            border-radius: 8px;
            font-weight: 600;
            margin-top: 0.25rem;
        }

        /* Sport type styling */
        .court-card.tennis {
            background-color: var(--tennis-green);
            color: #000;
        }

        .court-card.pickleball {
            background-color: var(--pickleball-blue);
            color: #000;
        }

        .court-card.tentative {
            background-color: var(--tentative-yellow);
            color: #000;
        }

        .court-card.available {
            background-color: var(--available-white);
            color: #6c757d;
        }

        .court-card.available .court-content {
            font-style: italic;
            font-weight: normal;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem;
        }

        .last-updated {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            margin: 1rem;
            font-size: 0.8rem;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid var(--border-color);
            padding: 0.5rem;
            z-index: 1000;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            text-decoration: none;
            color: #6c757d;
            font-size: 0.7rem;
            transition: color 0.3s ease;
        }

        .nav-btn.active {
            color: var(--tennis-green);
        }

        .nav-btn.filters-hidden {
            background-color: var(--tennis-green);
            color: white;
            border-radius: 8px;
        }

        .nav-btn i {
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }

        /* Legend for mobile */
        .mobile-legend {
            background: #f8f9fa;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .legend-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 0.5rem;
            border: 1px solid #ccc;
        }

        .no-data {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
            font-style: italic;
        }

        @media (max-width: 480px) {
            .courts-grid {
                grid-template-columns: 1fr;
            }
            
            .court-card {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            
            .court-card:last-child {
                border-bottom: none;
            }
            
            .filter-buttons {
                gap: 0.25rem;
            }
            
            .filter-btn {
                min-width: 70px;
                padding: 0.4rem;
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <div class="mobile-header">
        <h1>
            <i class="fas fa-calendar-alt me-2"></i>
            OTC Sports Center
        </h1>
        <div class="subtitle">Mobile Schedule</div>
    </div>

    <div class="mobile-controls">
        <div class="day-selector">
            <select class="form-select" id="daySelect" onchange="onDayChange()">
                <option value="0">Loading days...</option>
            </select>
        </div>
        
        <div class="time-range-selector">
            <select class="form-select" id="timeRangeSelect" onchange="onTimeRangeChange()">
                <option value="all">All Times</option>
                <option value="morning">Morning (6:00 AM - 12:00 PM)</option>
                <option value="afternoon">Afternoon (12:00 PM - 6:00 PM)</option>
                <option value="evening">Evening (6:00 PM - 10:00 PM)</option>
                <option value="early">Early (6:00 AM - 9:00 AM)</option>
                <option value="peak">Peak Hours (9:00 AM - 5:00 PM)</option>
            </select>
        </div>
        
        <div class="quick-time-buttons">
            <button class="quick-time-btn active" onclick="setTimeRange('all')" data-range="all">
                <i class="fas fa-clock"></i> All
            </button>
            <button class="quick-time-btn" onclick="setTimeRange('morning')" data-range="morning">
                <i class="fas fa-sun"></i> AM
            </button>
            <button class="quick-time-btn" onclick="setTimeRange('afternoon')" data-range="afternoon">
                <i class="fas fa-sun"></i> PM
            </button>
            <button class="quick-time-btn" onclick="setTimeRange('early')" data-range="early">
                <i class="fas fa-coffee"></i> Early
            </button>
        </div>
        
        <div class="search-box-container">
            <input type="text" class="search-box" id="searchInput" 
                   placeholder="Search by name..." onkeyup="filterTable()">
        </div>
        
        <div class="filter-buttons">
            <button class="filter-btn active" onclick="filterByStatus('all')" data-status="all">
                <i class="fas fa-list me-1"></i>All
            </button>
            <button class="filter-btn" onclick="filterByStatus('tennis')" data-status="tennis">
                <i class="fas fa-table-tennis me-1"></i>Tennis
            </button>
            <button class="filter-btn" onclick="filterByStatus('pickleball')" data-status="pickleball">
                <i class="fas fa-table-tennis me-1"></i>PB
            </button>
            <button class="filter-btn" onclick="filterByStatus('tentative')" data-status="tentative">
                <i class="fas fa-clock me-1"></i>Pending
            </button>
            <button class="filter-btn" onclick="filterByStatus('available')" data-status="available">
                <i class="fas fa-check me-1"></i>Open
            </button>
        </div>
        
        <div class="show-booked-toggle">
            <label class="toggle-switch">
                <input type="checkbox" id="showBookedOnly" onchange="toggleBookedOnly()">
                <span class="toggle-slider"></span>
                <span class="toggle-label">Show only booked times</span>
            </label>
        </div>
    </div>

    <!-- Mobile Legend -->
    <div class="mobile-legend">
        <div class="legend-grid">
            <div class="legend-item">
                <div class="legend-color" style="background-color: var(--tennis-green);"></div>
                <span>Tennis</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: var(--pickleball-blue);"></div>
                <span>Pickleball</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: var(--tentative-yellow);"></div>
                <span>Tentative</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: var(--available-white); border: 1px solid #ccc;"></div>
                <span>Available</span>
            </div>
        </div>
    </div>

    <!-- Mobile Schedule Cards -->
    <div class="container-fluid px-3" id="scheduleContainer">
        <div class="loading">
            <i class="fas fa-spinner fa-spin me-2"></i>
            Loading schedule data...
        </div>
    </div>

    <!-- Last Updated Info -->
    <div class="last-updated" id="lastUpdated" style="display: none;">
        <i class="fas fa-info-circle me-2"></i>
        <span id="lastUpdatedText"></span>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-buttons">
            <a href="#" class="nav-btn active" onclick="showSchedule()">
                <i class="fas fa-calendar-alt"></i>
                <span>Schedule</span>
            </a>
            <a href="#" class="nav-btn" onclick="toggleFilters()" id="filterToggleBtn">
                <i class="fas fa-filter"></i>
                <span>Filters</span>
            </a>
            <a href="#" class="nav-btn" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i>
                <span>Refresh</span>
            </a>
            <a href="/" class="nav-btn">
                <i class="fas fa-desktop"></i>
                <span>Desktop</span>
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let scheduleData = {};
        let currentFilter = 'all';
        let currentSearch = '';
        let currentTimeRange = 'all';
        let showBookedOnly = false;
        let filtersVisible = true;
        let lastScrollY = 0;
        let scrollTimeout;

        // Load schedule data
        async function loadScheduleData() {
            try {
                const response = await fetch('/schedule-processed');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Received data:', data);
                scheduleData = data.data || {};
                console.log('Schedule data:', scheduleData);
                
                updateDayDropdown();
                renderSchedule();
                updateLastUpdated(data.metadata.lastUpdated);
                
                // Auto-refresh every 30 minutes
                setTimeout(loadScheduleData, 30 * 60 * 1000);
                
            } catch (error) {
                console.error('Error loading schedule data:', error);
                document.getElementById('scheduleContainer').innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading schedule data. Please try refreshing the page.
                    </div>
                `;
            }
        }



        // Render the schedule as cards
        function renderSchedule() {
            console.log('Rendering schedule...');
            console.log('Schedule data:', scheduleData);
            
            const container = document.getElementById('scheduleContainer');
            let html = '';

            if (!scheduleData || typeof scheduleData !== 'object') {
                html = '<div class="no-data">No schedule data available</div>';
                container.innerHTML = html;
                return;
            }

            // Get the selected day
            const selectedDay = document.getElementById('daySelect').value;
            const dayData = scheduleData[selectedDay];
            
            if (!dayData || !dayData.timeSlots) {
                html = '<div class="no-data">No data for selected day</div>';
                container.innerHTML = html;
                return;
            }

            // Court names in order (excluding divider)
            const courtNames = ['Clay 1', 'PB Ct 1', 'PB Ct 2', 'PB Ct 3', 'PB Ct 4', 'Clay 2'];

            // Process each time slot
            dayData.timeSlots.forEach(timeSlot => {
                const time = timeSlot.time;
                const courts = timeSlot.courts;
                
                // Check if time slot matches current time range filter
                if (!isTimeInRange(time, currentTimeRange)) {
                    return; // Skip this time slot
                }
                
                // Check if this time slot has any content or if showing all
                let hasContent = false;
                const courtData = [];
                
                // Process courts (skip divider at index 3)
                courts.forEach((court, index) => {
                    if (index === 3) return; // Skip divider
                    
                    const courtIndex = index > 3 ? index - 1 : index; // Adjust for skipped divider
                    const courtName = courtNames[courtIndex];
                    
                    let courtClass = 'available';
                    let courtContent = 'Available';
                    let courtStatus = '';
                    
                    if (court.hasContent && court.value && court.value.trim()) {
                        courtContent = court.value;
                        courtClass = court.sportType || 'available';
                        
                        if (courtClass === 'tennis') {
                            courtStatus = '<span class="court-status bg-success text-white">Tennis</span>';
                        } else if (courtClass === 'pickleball') {
                            courtStatus = '<span class="court-status bg-primary text-white">Pickleball</span>';
                        } else if (courtClass === 'tentative') {
                            courtStatus = '<span class="court-status bg-warning text-dark">Tentative</span>';
                        }
                        
                        hasContent = true;
                    }
                    
                    courtData.push({
                        name: courtName,
                        class: courtClass,
                        content: courtContent,
                        status: courtStatus
                    });
                });
                
                // Only show time slots that have content or if showing all
                if (hasContent || (!showBookedOnly && currentFilter === 'all')) {
                    html += `
                        <div class="time-slot-card" data-time="${time}">
                            <div class="time-slot-header">
                                <i class="fas fa-clock me-2"></i>${time}
                            </div>
                            <div class="courts-grid">
                    `;
                    
                    courtData.forEach(court => {
                        html += `
                            <div class="court-card ${court.class}">
                                <div class="court-name">${court.name}</div>
                                <div class="court-content">${court.content}</div>
                                ${court.status}
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            });

            if (html === '') {
                html = '<div class="no-data">No reservations found for the selected day</div>';
            }

            container.innerHTML = html;
            applyFilters();
        }

        // Update day dropdown with parsed days
        function updateDayDropdown() {
            const daySelect = document.getElementById('daySelect');
            if (!scheduleData || Object.keys(scheduleData).length === 0) {
                daySelect.innerHTML = '<option value="0">No days found</option>';
                return;
            }
            
            daySelect.innerHTML = '';
            Object.keys(scheduleData).forEach(dayKey => {
                const dayData = scheduleData[dayKey];
                const option = document.createElement('option');
                option.value = dayKey;
                option.textContent = dayData.dayName || `Day ${dayKey}`;
                daySelect.appendChild(option);
            });
            
            // Set first day as default
            const firstDay = Object.keys(scheduleData)[0];
            daySelect.value = firstDay || '0';
            console.log('Day dropdown updated, selected value:', daySelect.value);
        }

        // Handle day selection change
        function onDayChange() {
            renderSchedule();
        }

        // Handle time range selection change
        function onTimeRangeChange() {
            currentTimeRange = document.getElementById('timeRangeSelect').value;
            updateQuickTimeButtons();
            renderSchedule();
        }

        // Set time range from quick buttons
        function setTimeRange(range) {
            currentTimeRange = range;
            document.getElementById('timeRangeSelect').value = range;
            updateQuickTimeButtons();
            renderSchedule();
        }

        // Update quick time button states
        function updateQuickTimeButtons() {
            document.querySelectorAll('.quick-time-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.range === currentTimeRange) {
                    btn.classList.add('active');
                }
            });
        }

        // Toggle show booked only
        function toggleBookedOnly() {
            showBookedOnly = document.getElementById('showBookedOnly').checked;
            renderSchedule();
        }

        // Toggle filters visibility
        function toggleFilters() {
            filtersVisible = !filtersVisible;
            const controls = document.querySelector('.mobile-controls');
            const filterBtn = document.getElementById('filterToggleBtn');
            
            if (filtersVisible) {
                controls.classList.remove('hidden');
                filterBtn.innerHTML = '<i class="fas fa-filter"></i><span>Hide</span>';
                filterBtn.classList.remove('filters-hidden');
            } else {
                controls.classList.add('hidden');
                filterBtn.innerHTML = '<i class="fas fa-filter"></i><span>Filters</span>';
                filterBtn.classList.add('filters-hidden');
            }
        }

        // Handle scroll events to auto-hide filters
        function handleScroll() {
            const currentScrollY = window.scrollY;
            const controls = document.querySelector('.mobile-controls');
            
            // Clear existing timeout
            clearTimeout(scrollTimeout);
            
            // If scrolling down and filters are visible, hide them
            if (currentScrollY > lastScrollY && currentScrollY > 100 && filtersVisible) {
                filtersVisible = false;
                controls.classList.add('hidden');
                const filterBtn = document.getElementById('filterToggleBtn');
                filterBtn.innerHTML = '<i class="fas fa-filter"></i><span>Filters</span>';
                filterBtn.classList.add('filters-hidden');
            }
            
            // Set timeout to show filters when scrolling stops
            scrollTimeout = setTimeout(() => {
                if (currentScrollY < 50 && !filtersVisible) {
                    filtersVisible = true;
                    controls.classList.remove('hidden');
                    const filterBtn = document.getElementById('filterToggleBtn');
                    filterBtn.innerHTML = '<i class="fas fa-filter"></i><span>Hide</span>';
                    filterBtn.classList.remove('filters-hidden');
                }
            }, 1000);
            
            lastScrollY = currentScrollY;
        }

        // Check if a time string is within the specified range
        function isTimeInRange(timeStr, range) {
            if (range === 'all') return true;
            
            // Parse time string (e.g., "6:30 AM", "2:00 PM")
            const [time, period] = timeStr.split(' ');
            const [hours, minutes] = time.split(':').map(Number);
            
            // Convert to 24-hour format
            let hour24 = hours;
            if (period === 'PM' && hours !== 12) {
                hour24 += 12;
            } else if (period === 'AM' && hours === 12) {
                hour24 = 0;
            }
            
            // Convert to decimal hours for easier comparison
            const decimalHour = hour24 + (minutes / 60);
            
            switch (range) {
                case 'morning':
                    return decimalHour >= 6 && decimalHour < 12;
                case 'afternoon':
                    return decimalHour >= 12 && decimalHour < 18;
                case 'evening':
                    return decimalHour >= 18 && decimalHour < 22;
                case 'early':
                    return decimalHour >= 6 && decimalHour < 9;
                case 'peak':
                    return decimalHour >= 9 && decimalHour < 17;
                default:
                    return true;
            }
        }

        // Filter by status
        function filterByStatus(status) {
            currentFilter = status;
            
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.status === status) {
                    btn.classList.add('active');
                }
            });
            
            renderSchedule();
        }

        // Filter table by search term
        function filterTable() {
            currentSearch = document.getElementById('searchInput').value.toLowerCase();
            applyFilters();
        }

        // Apply search filters
        function applyFilters() {
            const cards = document.querySelectorAll('.time-slot-card');
            
            cards.forEach(card => {
                const courts = card.querySelectorAll('.court-card');
                let shouldShow = true;
                
                // Check search filter
                if (currentSearch) {
                    const hasMatchingText = Array.from(courts).some(court => 
                        court.textContent.toLowerCase().includes(currentSearch)
                    );
                    if (!hasMatchingText) shouldShow = false;
                }
                
                card.style.display = shouldShow ? '' : 'none';
            });
        }

        // Refresh data manually
        function refreshData() {
            loadScheduleData();
        }

        // Show schedule (for bottom nav)
        function showSchedule() {
            // Already on schedule page
        }

        // Update last updated timestamp
        function updateLastUpdated(timestamp) {
            const lastUpdated = document.getElementById('lastUpdated');
            const lastUpdatedText = document.getElementById('lastUpdatedText');
            
            if (timestamp) {
                const date = new Date(timestamp);
                lastUpdatedText.textContent = `Last updated: ${date.toLocaleString()}`;
                lastUpdated.style.display = 'block';
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadScheduleData();
            
            // Add scroll event listener for auto-hiding filters
            window.addEventListener('scroll', handleScroll, { passive: true });
        });
    </script>
</body>
</html>